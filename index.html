<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Goal Tracker — Single File</title>
<style>
  :root{
    --bg:#07080a; --card:#0f1113; --muted:#98a0a6; --accent:#3b82f6;
    --glass: rgba(255,255,255,0.03); --success:#10b981;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:linear-gradient(180deg,var(--bg),#050608); color:#e9f0f7}
  .container{max-width:1100px; margin:18px auto; padding:16px; display:grid; grid-template-columns:360px 1fr; gap:18px}
  .card{background:var(--card); border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  h1{margin:0;font-size:20px}
  label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
  input,textarea,select,button{font-size:14px;border-radius:8px;padding:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;width:100%}
  textarea{resize:vertical}
  .row{display:flex;gap:10px}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .btn{background:var(--accent); color:#071126; border:none; cursor:pointer; font-weight:600}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  .sidebar{height:82vh; overflow:auto}
  .content{height:82vh; overflow:auto}
  .goal-list{display:grid;gap:12px;margin-top:8px}
  .goal-card{padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))}
  .thumb{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,0.04)}
  .progress-wrap{height:10px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
  .progress{height:100%;background:linear-gradient(90deg,var(--accent),#6ee7b7);width:0%}
  .file-drop{width:160px;height:120px;border-radius:8px;border:2px dashed rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
  .file-drop img{max-width:100%;max-height:100%;object-fit:cover}
  footer.small{color:var(--muted);text-align:center;margin-top:12px}
  @media(max-width:900px){ .container{grid-template-columns:1fr;padding:12px} .sidebar{order:2}.content{order:1} }
</style>
</head>
<body>
  <div class="container">
    <aside class="card sidebar" aria-label="Left sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h1>Goal Tracker</h1>
          <div class="muted small">Minimal • Dark • Responsive</div>
        </div>
        <div id="session-area"></div>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0">

      <div id="auth-pane">
        <div id="login-form">
          <div style="margin-bottom:10px">
            <label>Username (3-12 letters)</label>
            <input id="username" maxlength="12" placeholder="e.g. kingkra" />
          </div>
          <div style="margin-bottom:10px">
            <label>Password (6 digits)</label>
            <input id="password" maxlength="6" placeholder="123456" />
          </div>
          <div class="row">
            <button id="btn-login" class="btn">Login</button>
            <button id="btn-register" class="btn ghost">Register</button>
          </div>
          <div class="muted small" style="margin-top:8px">Password exactly 6 digits. Username English letters only.</div>
        </div>

        <div id="user-controls" style="display:none;margin-top:12px">
          <div class="muted small">Logged in as <strong id="me"></strong></div>
          <div style="margin-top:8px" class="row">
            <button id="btn-logout" class="btn">Logout</button>
            <button id="btn-logout-all" class="btn ghost">Logout All</button>
          </div>
          <div style="margin-top:8px" class="row">
            <button id="btn-change-pw" class="btn ghost">Change Password</button>
          </div>
        </div>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0">

      <div>
        <h2 style="font-size:14px;margin:0 0 8px 0">Your Goals</h2>
        <div id="goals-empty" class="muted">No goals yet — add one!</div>
        <div id="goal-list" class="goal-list" aria-live="polite"></div>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0">

      <div>
        <h2 style="font-size:14px;margin:6px 0">Data</h2>
        <div class="row">
          <button id="btn-export" class="btn">Export</button>
          <button id="btn-import" class="btn ghost">Import</button>
          <button id="btn-reset" class="btn ghost">Reset</button>
        </div>
        <input id="import-file" type="file" accept="application/json" style="display:none" />
      </div>
    </aside>

    <main class="card content" aria-label="Main content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h1 id="pane-title">Add New Goal</h1>
          <div class="muted small">Targets, notes, link & image — THB shown when applicable</div>
        </div>
        <div>
          <button id="btn-refresh" class="btn ghost">Refresh</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div id="form-area">
          <div style="margin-bottom:10px">
            <label>Goal Title</label>
            <input id="goal-title" placeholder="e.g. New Phone" />
          </div>

          <div class="row" style="margin-bottom:10px">
            <div style="flex:1">
              <label>Target (numeric)</label>
              <input id="goal-target" placeholder="e.g. 20000" />
            </div>
            <div style="width:170px">
              <label>Current</label>
              <input id="goal-current" placeholder="0" />
            </div>
          </div>

          <div style="margin-bottom:10px">
            <label>Note</label>
            <textarea id="goal-note" rows="3" placeholder="Why this matters..."></textarea>
          </div>

          <div class="row" style="align-items:flex-end;margin-bottom:10px">
            <div style="flex:1">
              <label>Product Link (optional)</label>
              <input id="goal-link" placeholder="https://..." />
            </div>
            <div style="width:180px">
              <label>Image (click to view / right-click to replace / drag & drop)</label>
              <div id="file-drop" class="file-drop" title="Click or drop image">
                <span class="muted small">Drop image or click</span>
                <input id="image-file" type="file" accept="image/*" style="display:none" />
              </div>
            </div>
          </div>

          <div class="row" style="gap:8px">
            <button id="btn-add-goal" class="btn">Add Goal</button>
            <button id="btn-clear-form" class="btn ghost">Clear</button>
          </div>
        </div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:18px 0">

        <div id="detail-area">
          <h2 style="font-size:16px;margin:0 0 12px 0">Goal Details</h2>
          <div id="detail-card" style="display:none"></div>
        </div>
      </div>

      <footer class="small">Built for you — single-file app.</footer>
    </main>
  </div>

<script>
/* ========== CONFIG ========== */
const SCRIPT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzUtU800oG4t1GYW4vJyGJAOqBGYDgE8VqojcV3Elbe2E-Pc-ilVYFQsdQdH/usercurrent';

const el = id => document.getElementById(id);
const isDebug = true;

function log(...args){ if(isDebug) console.log(...args) }
function toast(msg){ try{ console.log('TOAST:', msg) } catch(e){} alert(msg) }

function validUsername(u){ return /^[A-Za-z]{3,12}$/.test(u) }
function validPassword(p){ return /^\d{6}$/.test(p) }
function toNumber(v){ const n = Number(String(v).replace(/[^0-9.\-]/g,'')); return isNaN(n)?0:n }
function formatTHB(n){ if(typeof n!=='number') n = Number(n)||0; return n.toLocaleString('th-TH',{style:'currency',currency:'THB'}) }

let SESSION = {username:null, token:null};
function saveSession(){ localStorage.setItem('gt_session', JSON.stringify(SESSION)) }
function loadSession(){ const s = localStorage.getItem('gt_session'); if(s){ try{ SESSION = JSON.parse(s) }catch(e){} } renderAuth() }

/* API caller */
async function api(action, payload = {}){
  payload.action = action;
  payload._ts = Date.now();
  try{
    const res = await fetch(SCRIPT_ENDPOINT, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    return json;
  }catch(err){
    log('API ERROR', err);
    toast('Network error or SCRIPT_ENDPOINT not set correctly');
    return {success:false, error:String(err)};
  }
}

/* Render auth area */
function renderAuth(){
  if(SESSION.username && SESSION.token){
    el('login-form').style.display = 'none';
    el('user-controls').style.display = 'block';
    el('me').textContent = SESSION.username;
    el('goals-empty').style.display = 'none';
    fetchGoals();
  } else {
    el('login-form').style.display = 'block';
    el('user-controls').style.display = 'none';
    el('me').textContent = '';
    el('goal-list').innerHTML = '';
    el('goals-empty').style.display = 'block';
  }
}

/* AUTH ACTIONS */
el('btn-register').addEventListener('click', async ()=>{
  const u = el('username').value.trim();
  const p = el('password').value.trim();
  if(!validUsername(u)) return toast('Username must be 3-12 English letters');
  if(!validPassword(p)) return toast('Password must be exactly 6 digits');
  const r = await api('register',{username:u,password:p});
  if(r.success) toast('Registered — please log in'); else toast(r.error||'Register failed');
});

el('btn-login').addEventListener('click', async ()=>{
  const u = el('username').value.trim();
  const p = el('password').value.trim();
  if(!validUsername(u)) return toast('Username must be 3-12 English letters');
  if(!validPassword(p)) return toast('Password must be exactly 6 digits');
  const r = await api('login',{username:u,password:p});
  if(r.success && r.token){ SESSION.username = u; SESSION.token = r.token; saveSession(); renderAuth(); toast('Logged in'); }
  else toast(r.error||'Login failed');
});

el('btn-logout').addEventListener('click', async ()=>{
  if(!SESSION.username) return;
  const r = await api('logout',{username:SESSION.username, token:SESSION.token});
  if(r.success){ SESSION = {username:null, token:null}; saveSession(); renderAuth(); toast('Logged out'); }
  else toast(r.error||'Logout failed');
});

el('btn-logout-all').addEventListener('click', async ()=>{
  if(!SESSION.username) return;
  const r = await api('logoutAll',{username:SESSION.username, token:SESSION.token});
  if(r.success){ SESSION = {username:null, token:null}; saveSession(); renderAuth(); toast('All sessions logged out'); }
  else toast(r.error||'Failed');
});

el('btn-change-pw').addEventListener('click', async ()=>{
  if(!SESSION.username) return toast('Login first');
  const newPw = prompt('Enter new password (6 digits):');
  if(!newPw) return;
  if(!validPassword(newPw)) return toast('Password must be exactly 6 digits');
  const r = await api('changePassword',{username:SESSION.username, token:SESSION.token, newPassword:newPw});
  if(r.success){ SESSION = {username:null, token:null}; saveSession(); renderAuth(); toast('Password changed — please log in again') }
  else toast(r.error||'Failed');
});

/* IMAGE / DROP UX */
let pendingImageDataUrl = null;
const fileInput = el('image-file'), drop = el('file-drop');

function setDropPreview(dataUrl){
  pendingImageDataUrl = dataUrl;
  drop.innerHTML = '';
  const img = document.createElement('img'); img.src = dataUrl; img.alt = 'preview';
  drop.appendChild(img);
  img.addEventListener('click', ()=> {
    const w = window.open(''); w.document.write(`<img src="${dataUrl}" style="max-width:100%">`);
  });
  // right-click -> open hidden file input for quick change
  drop.oncontextmenu = e => { e.preventDefault(); fileInput.click(); }
}

fileInput.addEventListener('change', ()=> {
  const f = fileInput.files[0];
  if(!f) return;
  if(!f.type.startsWith('image/')) return toast('Not an image file');
  const reader = new FileReader();
  reader.onload = e => setDropPreview(e.target.result);
  reader.readAsDataURL(f);
});

/* drag & drop handlers (visual feedback minimal) */
['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); drop.style.borderColor = 'rgba(59,130,246,0.6)'; }));
['dragleave','drop'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); drop.style.borderColor = 'rgba(255,255,255,0.04)'; }));
drop.addEventListener('drop', e => {
  e.preventDefault();
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(!f) return;
  if(!f.type.startsWith('image/')) return toast('Not an image');
  const r = new FileReader();
  r.onload = ev => setDropPreview(ev.target.result);
  r.readAsDataURL(f);
});
drop.addEventListener('click', ()=> fileInput.click());

/* ADD GOAL */
el('btn-add-goal').addEventListener('click', async ()=>{
  if(!SESSION.username) return toast('Login first');
  const title = el('goal-title').value.trim(); if(!title) return toast('Title required');
  const target = toNumber(el('goal-target').value); const current = toNumber(el('goal-current').value);
  const note = el('goal-note').value.trim(); const link = el('goal-link').value.trim(); const image = pendingImageDataUrl || '';
  const payload = {username:SESSION.username, token:SESSION.token, goal:{title,target,current,note,link,image}};
  const r = await api('addGoal', payload);
  if(r.success){ toast('Goal added'); clearForm(); fetchGoals(); }
  else toast(r.error||'Add failed');
});

function clearForm(){
  el('goal-title').value=''; el('goal-target').value=''; el('goal-current').value=''; el('goal-note').value=''; el('goal-link').value='';
  pendingImageDataUrl = null; drop.innerHTML = '<span class="muted small">Drop image or click</span>';
  el('btn-add-goal').textContent = 'Add Goal';
}

/* FETCH & RENDER GOALS */
el('btn-refresh').addEventListener('click', ()=> fetchGoals());

async function fetchGoals(){
  if(!SESSION.username) return;
  const r = await api('getGoals',{username:SESSION.username, token:SESSION.token});
  if(!r.success) return toast(r.error||'Failed to load');
  renderGoals(r.goals||[]);
}

function renderGoals(goals){
  const list = el('goal-list'); list.innerHTML = '';
  if(!goals || goals.length===0){ el('goals-empty').style.display = 'block'; return }
  el('goals-empty').style.display = 'none';
  goals.forEach(g=>{
    const percent = (g.target>0)? Math.min(100, Math.round((g.current/g.target)*100)): (g.current>0?100:0);
    const isCurrency = !!g.isCurrency;
    const targetDisp = isCurrency? formatTHB(Number(g.target)): Number(g.target).toLocaleString();
    const currentDisp = isCurrency? formatTHB(Number(g.current)): Number(g.current).toLocaleString();
    const card = document.createElement('div'); card.className = 'goal-card';
    card.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <div style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:600">${escapeHtml(g.title)}</div>
              <div class="muted small">Target: ${escapeHtml(String(targetDisp))} • Current: ${escapeHtml(String(currentDisp))}</div>
              <div class="muted small">Added: ${escapeHtml(localizeDate(g.dateAdded||g.createdAt))}</div>
            </div>
            <div class="muted small">${percent}%</div>
          </div>
          <div style="margin-top:8px"><div class="progress-wrap"><div class="progress" style="width:${percent}%"></div></div></div>
        </div>
        <div style="width:78px;text-align:right">
          ${g.image? `<img class="thumb" src="${escapeHtml(g.image)}" data-id="${g.id}" />` : ''}
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn view-btn" data-id="${g.id}">View</button>
        <button class="btn ghost edit-btn" data-id="${g.id}">Edit</button>
        <button class="btn ghost delete-btn" data-id="${g.id}">Delete</button>
      </div>
    `;
    list.appendChild(card);

    // attach image event handlers: click = open, right-click = replace
    if(g.image){
      const img = card.querySelector('img.thumb');
      if(img){
        img.addEventListener('click', ()=>{ const w = window.open(''); w.document.write(`<img src="${g.image}" style="max-width:100%">`); });
        img.addEventListener('contextmenu', async (ev)=>{ ev.preventDefault();
          const picked = await pickLocalImage();
          if(!picked) return;
          const res = await api('updateGoalImage',{username:SESSION.username, token:SESSION.token, id:g.id, image:picked});
          if(res.success) { toast('Image updated'); fetchGoals(); } else toast(res.error||'Failed');
        });
      }
    }
  });

  // delegation for view/edit/delete (attach after adding items)
  document.querySelectorAll('.view-btn').forEach(b=> b.addEventListener('click', e=> viewGoal(e.target.dataset.id)));
  document.querySelectorAll('.edit-btn').forEach(b=> b.addEventListener('click', e=> editGoal(e.target.dataset.id)));
  document.querySelectorAll('.delete-btn').forEach(b=> b.addEventListener('click', e=> deleteGoal(e.target.dataset.id)));
}

/* Utility to open file picker and return dataUrl */
function pickLocalImage(){
  return new Promise(resolve=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*';
    inp.onchange = ()=> {
      const f = inp.files[0]; if(!f) return resolve(null);
      const r = new FileReader();
      r.onload = e => resolve(e.target.result);
      r.readAsDataURL(f);
    };
    inp.click();
  });
}

/* View / Edit / Delete */
async function viewGoal(id){
  const r = await api('getGoal',{username:SESSION.username, token:SESSION.token, id});
  if(!r.success) return toast(r.error||'Failed');
  const g = r.goal;
  el('detail-card').style.display = 'block';
  el('detail-card').innerHTML = `
    <div class="goal-card">
      <div style="display:flex;gap:12px;align-items:center">
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(g.title)}</div>
          <div class="muted small">${escapeHtml(g.note||'')}</div>
          <div style="margin-top:8px">Link: ${g.link? `<a class="muted" href="${escapeHtml(g.link)}" target="_blank">Open Product</a>` : '—'}</div>
          <div class="muted small" style="margin-top:6px">Added: ${escapeHtml(localizeDate(g.dateAdded||g.createdAt))}</div>
        </div>
        <div style="text-align:right">${g.image? `<img class="thumb" src="${escapeHtml(g.image)}"/>` : ''}</div>
      </div>
    </div>
  `;
}

async function editGoal(id){
  const r = await api('getGoal',{username:SESSION.username, token:SESSION.token, id});
  if(!r.success) return toast(r.error||'Failed to fetch');
  const g = r.goal;
  el('goal-title').value = g.title || '';
  el('goal-target').value = g.target || '';
  el('goal-current').value = g.current || '';
  el('goal-note').value = g.note || '';
  el('goal-link').value = g.link || '';
  pendingImageDataUrl = g.image || null;
  if(pendingImageDataUrl) setDropPreview(pendingImageDataUrl);
  el('btn-add-goal').textContent = 'Save Changes';

  const old = el('btn-add-goal');
  const clone = old.cloneNode(true);
  old.parentNode.replaceChild(clone, old);

  clone.addEventListener('click', async ()=>{
    const title = el('goal-title').value.trim(); if(!title) return toast('Title required');
    const target = toNumber(el('goal-target').value); const current = toNumber(el('goal-current').value);
    const note = el('goal-note').value.trim(); const link = el('goal-link').value.trim(); const image = pendingImageDataUrl || '';
    const res = await api('updateGoal',{username:SESSION.username, token:SESSION.token, id, goal:{title,target,current,note,link,image}});
    if(res.success){ toast('Saved'); clearForm(); fetchGoals(); }
    else toast(res.error||'Save failed');
  });
}

async function deleteGoal(id){
  if(!confirm('Delete this goal?')) return;
  const r = await api('deleteGoal',{username:SESSION.username, token:SESSION.token, id});
  if(r.success){ toast('Deleted'); fetchGoals(); } else toast(r.error||'Delete failed');
}

/* Export / Import / Reset */
el('btn-export').addEventListener('click', async ()=>{
  if(!SESSION.username) return toast('Login first');
  const r = await api('exportData',{username:SESSION.username, token:SESSION.token});
  if(!r.success) return toast(r.error||'Export failed');
  const blob = new Blob([JSON.stringify(r.data, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `goals_${SESSION.username}_${new Date().toISOString()}.json`; a.click(); URL.revokeObjectURL(a.href);
});

el('btn-import').addEventListener('click', ()=> el('import-file').click());
el('import-file').addEventListener('change', async ()=>{
  const f = el('import-file').files[0]; if(!f) return;
  try{
    const txt = await f.text(); const data = JSON.parse(txt);
    if(!Array.isArray(data)) return toast('Invalid format');
    const r = await api('importData',{username:SESSION.username, token:SESSION.token, data});
    if(r.success){ toast('Import complete'); fetchGoals(); } else toast(r.error||'Import failed');
  }catch(e){ toast('Invalid JSON') }
});

el('btn-reset').addEventListener('click', async ()=>{
  if(!confirm('Reset (delete) all your goals? This cannot be undone.')) return;
  const r = await api('resetData',{username:SESSION.username, token:SESSION.token});
  if(r.success){ toast('Reset done'); fetchGoals(); } else toast(r.error||'Reset failed');
});

/* Utility helpers */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function localizeDate(iso){ if(!iso) return '—'; try{ const d = new Date(iso); return d.toLocaleString('th-TH',{hour12:false}); }catch(e){ return iso } }
function isLikelyCurrency(v){ const n = Number(v||0); return !isNaN(n) && Math.abs(n) >= 1000; }

window.addEventListener('DOMContentLoaded', ()=>{
  loadSession();
  log('App ready');
});
</script>
</body>
</html>
